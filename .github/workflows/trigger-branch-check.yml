name: '[test] Comment Trigger Branch Check'

on:
  issue_comment:
    types: [ created ]

jobs:
  test-branch-check:
    if: github.event.issue.pull_request != null && startsWith(github.event.comment.body, 'update-v4-schema')
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Get PR info and output
        id: pr-info
        env:
          PR_JSON: ${{ toJson(github.event.issue.pull_request) }}
          PR_BRANCH: ${{ github.event.issue.pull_request.head.ref }}
        run: |
          echo "full-pr-json=$PR_JSON" >> $GITHUB_OUTPUT
          echo "branch-name=$PR_BRANCH" >> $GITHUB_OUTPUT

    steps:
      - name: Post result comment
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = context.payload.issue.pull_request.head.ref;
            const prJson = context.payload.issue.pull_request;

            let message = "";
            message += "ブランチ名の検証結果：\n\n";
            message += "- head.ref から取得したブランチ名: `" + branchName + "`\n";
            message += "- pull_request 全体の内容:\n";
            message += "```json\n";
            message += JSON.stringify(prJson, null, 2) + "\n";
            message += "```\n";

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });